<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Termux Cloud Monitor</title>
    
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#020617">
    
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #000; overflow: hidden; font-family: sans-serif; }
        #remote-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        #remoteVideo { width: 100%; height: 100%; object-fit: cover; }
        #local-container { 
            position: absolute; bottom: 100px; right: 20px; width: 110px; height: 160px; 
            z-index: 10; border: 2px solid #38bdf8; border-radius: 15px; overflow: hidden;
        }
        #localVideo { width: 100%; height: 100%; object-fit: cover; background: #111; }
        .top-bar { 
            position: absolute; top: 0; width: 100%; padding: 15px; 
            background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent); 
            z-index: 20; text-align: center; color: #38bdf8; font-weight: bold; font-size: 14px;
        }
        .controls { 
            position: absolute; bottom: 0; width: 100%; height: 90px; 
            background: rgba(0,0,0,0.4); backdrop-filter: blur(10px);
            display: flex; justify-content: space-evenly; align-items: center; z-index: 30;
        }
        .btn { 
            width: 55px; height: 55px; border-radius: 50%; border: none; 
            background: rgba(255,255,255,0.1); color: white; font-size: 22px; 
            display: flex; align-items: center; justify-content: center;
        }
        .btn-call { background: #2563eb; width: 70px; border-radius: 18px; }
        .btn-rec { background: #991b1b; }
        .rec-active { animation: blink 1s infinite; background: #ff0000 !important; }
        @keyframes blink { 50% { opacity: 0.4; } }
        @media (orientation: landscape) {
            #local-container { width: 160px; height: 90px; bottom: 20px; right: 100px; }
            .controls { width: 90px; height: 100%; right: 0; flex-direction: column; }
        }
    </style>
</head>
<body>

    <div class="top-bar" id="my-id">SİSTEM BAĞLANIYOR...</div>
    <div id="remote-container"><video id="remoteVideo" autoplay playsinline></video></div>
    <div id="local-container"><video id="localVideo" autoplay muted playsinline></video></div>

    <div class="controls">
        <button class="btn" onclick="tgl('A')"><i class="fa fa-microphone" id="micI"></i></button>
        <button class="btn" onclick="tgl('V')"><i class="fa fa-video" id="camI"></i></button>
        <button class="btn btn-call" onclick="arama()"><i class="fa fa-phone"></i></button>
        <button class="btn" onclick="sw()"><i class="fa fa-sync"></i></button>
        <button class="btn btn-rec" id="recBtn" onclick="toggleRec()"><i class="fa fa-circle"></i></button>
    </div>

<script>
    // --- BURAYI KENDİNE GÖRE DEĞİŞTİR (MAKS 10 HARF) ---
    const myCustomID = "REIS_Kamera"; 
    // --------------------------------------------------

    let peer = new Peer(myCustomID);
    let myStream, recorder, chunks = [];
    let camMode = "user";

    async function initCamera(mode) {
        if(myStream) myStream.getTracks().forEach(t => t.stop());
        try {
            myStream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: mode, width: 1920, height: 1080, frameRate: 25 },
                audio: true
            });
            document.getElementById('localVideo').srcObject = myStream;
        } catch(e) {
            myStream = await navigator.mediaDevices.getUserMedia({video: true, audio: true});
            document.getElementById('localVideo').srcObject = myStream;
        }
    }

    peer.on('open', id => document.getElementById('my-id').innerText = "ID: " + id);
    peer.on('call', call => {
        call.answer(myStream);
        setBitrate(call);
        call.on('stream', s => document.getElementById('remoteVideo').srcObject = s);
    });

    function arama() {
        let rId = prompt("Bağlanılacak ID:");
        if(rId) {
            let call = peer.call(rId, myStream);
            setBitrate(call);
            call.on('stream', s => document.getElementById('remoteVideo').srcObject = s);
        }
    }

    function setBitrate(call) {
        call.peerConnection.addEventListener('iceconnectionstatechange', () => {
            if (call.peerConnection.iceConnectionState === 'connected') {
                const videoSender = call.peerConnection.getSenders().find(s => s.track.kind === 'video');
                const params = videoSender.getParameters();
                if (!params.encodings) params.encodings = [{}];
                params.encodings[0].maxBitrate = 1500000; // 720p HD Yayın Sınırı
                videoSender.setParameters(params);
            }
        });
    }

    function toggleRec() {
        if (!recorder || recorder.state === "inactive") {
            chunks = [];
            let options = { mimeType: 'video/webm;codecs=h264', videoBitsPerSecond: 2500000 };
            if (!MediaRecorder.isTypeSupported(options.mimeType)) options.mimeType = 'video/webm;codecs=vp8';
            
            recorder = new MediaRecorder(myStream, options);
            recorder.ondataavailable = e => chunks.push(e.data);
            recorder.onstop = () => {
                const blob = new Blob(chunks, { type: 'video/webm' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `FHD_KAYIT_${Date.now()}.webm`;
                a.click();
            };
            recorder.start(2000); 
            document.getElementById('recBtn').classList.add('rec-active');
        } else {
            recorder.stop();
            document.getElementById('recBtn').classList.remove('rec-active');
        }
    }

    function tgl(t) {
        let tr = t === 'A' ? myStream.getAudioTracks()[0] : myStream.getVideoTracks()[0];
        tr.enabled = !tr.enabled;
        document.getElementById(t === 'A' ? 'micI' : 'camI').className = `fa fa-${t==='A'?(tr.enabled?'microphone':'microphone-slash'):(tr.enabled?'video':'video-slash')}`;
    }

    async function sw() {
        camMode = (camMode === "user") ? "environment" : "user";
        await initCamera(camMode);
    }

    initCamera(camMode);
</script>
</body>
</html>
