<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Taylos Cam Stable</title>
<script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<style>
body,html{margin:0;padding:0;background:#000;height:100%;overflow:hidden}
video{width:100%;height:100%;object-fit:cover}
#local{position:absolute;bottom:100px;right:20px;width:120px;height:160px;border:2px solid #38bdf8;border-radius:15px;overflow:hidden}
.controls{position:absolute;bottom:0;width:100%;height:90px;background:rgba(0,0,0,.5);display:flex;justify-content:space-evenly;align-items:center}
button{width:55px;height:55px;border-radius:50%;border:none;background:#222;color:#fff;font-size:20px}
.rec-active{background:red!important}
.top{position:absolute;top:0;width:100%;text-align:center;color:#38bdf8;background:rgba(0,0,0,.6);padding:10px}
</style>
</head>

<body>

<div class="top" id="myid">BAĞLANIYOR...</div>

<video id="remote" autoplay playsinline></video>

<div id="local">
<video id="me" autoplay muted playsinline></video>
</div>

<div class="controls">
<button onclick="tgl('A')"><i class="fa fa-microphone" id="micI"></i></button>
<button onclick="tgl('V')"><i class="fa fa-video" id="camI"></i></button>
<button onclick="callPeer()"><i class="fa fa-phone"></i></button>
<button onclick="switchCam()"><i class="fa fa-sync"></i></button>
<button id="recBtn" onclick="toggleRec()"><i class="fa fa-circle"></i></button>
</div>

<script>

let camMode="user";
let myStream, recorder, chunks=[];
const id="taylos-"+Math.random().toString(36).substr(2,4);
const peer=new Peer(id);

peer.on("open",i=>document.getElementById("myid").innerText="ID: "+i);

async function initCam(){
if(myStream) myStream.getTracks().forEach(t=>t.stop());

myStream=await navigator.mediaDevices.getUserMedia({
video:{
facingMode:camMode,
width:{ideal:1280},
height:{ideal:720},
frameRate:{ideal:25,max:25}
},
audio:true
});

document.getElementById("me").srcObject=myStream;
}
initCam();

function switchCam(){
camMode=(camMode==="user")?"environment":"user";
initCam();
}

function callPeer(){
let rid=prompt("ID gir:");
if(!rid)return;
let call=peer.call(rid,myStream);
call.on("stream",s=>document.getElementById("remote").srcObject=s);
}

peer.on("call",call=>{
call.answer(myStream);
call.on("stream",s=>document.getElementById("remote").srcObject=s);
});

function tgl(t){
let tr=t==='A'?myStream.getAudioTracks()[0]:myStream.getVideoTracks()[0];
tr.enabled=!tr.enabled;
}

function toggleRec(){

if(!recorder || recorder.state==="inactive"){

chunks=[];

recorder=new MediaRecorder(myStream,{
mimeType:'video/webm;codecs=vp8',
videoBitsPerSecond:1500000
});

recorder.ondataavailable=e=>{
if(e.data.size>0)chunks.push(e.data);
};

recorder.onstop=()=>{

const blob=new Blob(chunks,{type:'video/webm'});

const reader=new FileReader();
reader.readAsDataURL(blob);

reader.onloadend=function(){
const a=document.createElement("a");
a.href=reader.result;
a.download="TAYLOS_"+Date.now()+".webm";
a.click();
};
};

recorder.start(2000);
document.getElementById("recBtn").classList.add("rec-active");

}else{
recorder.stop();
document.getElementById("recBtn").classList.remove("rec-active");
}

}

</script>
</body>
</html>    border:2px solid #38bdf8;
    border-radius:15px;
    overflow:hidden;
    z-index:10;
}
.controls{
    position:absolute;
    bottom:0;
    width:100%;
    height:90px;
    background:rgba(0,0,0,0.5);
    display:flex;
    justify-content:space-evenly;
    align-items:center;
}
.btn{
    width:55px;
    height:55px;
    border-radius:50%;
    border:none;
    background:rgba(255,255,255,0.1);
    color:white;
    font-size:20px;
}
.btn-rec{
    background:#991b1b;
}
.rec-active{
    background:red!important;
}
.top-bar{
    position:absolute;
    top:0;
    width:100%;
    padding:10px;
    text-align:center;
    color:#38bdf8;
    background:rgba(0,0,0,0.6);
}
</style>
</head>

<body>

<div class="top-bar" id="my-id">BAĞLANTI KURULUYOR...</div>

<div id="remote-container">
    <video id="remoteVideo" autoplay playsinline></video>
</div>

<div id="local-container">
    <video id="localVideo" autoplay muted playsinline></video>
</div>

<div class="controls">
    <button class="btn" onclick="tgl('A')"><i class="fa fa-microphone" id="micI"></i></button>
    <button class="btn" onclick="tgl('V')"><i class="fa fa-video" id="camI"></i></button>
    <button class="btn" onclick="arama()"><i class="fa fa-phone"></i></button>
    <button class="btn btn-rec" id="recBtn" onclick="toggleRec()">
        <i class="fa fa-circle"></i>
    </button>
</div>

<script>

// ---- DİNAMİK ID ----
const randomSuffix = Math.random().toString(36).substr(2, 4);
const myCustomID = "taylos-" + randomSuffix;
let peer = new Peer(myCustomID);

let myStream, recorder, chunks = [];
let camMode = "user";

// ---- 1080P 25FPS KAMERA ----
async function initCamera(mode) {
    if(myStream) myStream.getTracks().forEach(t => t.stop());

    try{
        myStream = await navigator.mediaDevices.getUserMedia({
            video:{
                facingMode:mode,
                width:{ideal:1920},
                height:{ideal:1080},
                frameRate:{ideal:25,max:25}
            },
            audio:true
        });
    }catch(e){
        myStream = await navigator.mediaDevices.getUserMedia({video:true,audio:true});
    }

    document.getElementById("localVideo").srcObject = myStream;
}

peer.on('open', id=>{
    document.getElementById("my-id").innerText="SENİN ID: "+id;
});

peer.on('call', call=>{
    call.answer(myStream);
    call.on('stream', s=>{
        document.getElementById("remoteVideo").srcObject=s;
    });
});

function arama(){
    let rId = prompt("Bağlanmak istediğin ID:");
    if(rId){
        let call = peer.call(rId,myStream);
        call.on('stream', s=>{
            document.getElementById("remoteVideo").srcObject=s;
        });
    }
}

// ---- 1080P HAFİF KAYIT (2 Mbps) ----
function toggleRec(){

    if(!recorder || recorder.state==="inactive"){

        chunks=[];

        let options={
            mimeType:'video/webm;codecs=vp8',
            videoBitsPerSecond:2000000
        };

        recorder=new MediaRecorder(myStream,options);

        recorder.ondataavailable=e=>{
            if(e.data.size>0) chunks.push(e.data);
        };

        recorder.onstop=()=>{
            const blob=new Blob(chunks,{type:'video/webm'});
            const url=URL.createObjectURL(blob);

            // WebView uyumlu indirme
            const a=document.createElement("a");
            a.style.display="none";
            a.href=url;
            a.download="KAYIT_"+Date.now()+".webm";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);

            setTimeout(()=>URL.revokeObjectURL(url),100);
        };

        recorder.start(2000);

        document.getElementById("recBtn").classList.add("rec-active");

    }else{
        recorder.stop();
        document.getElementById("recBtn").classList.remove("rec-active");
    }
}

// ---- Mic & Cam ----
function tgl(t){
    let tr = t==='A'?myStream.getAudioTracks()[0]:myStream.getVideoTracks()[0];
    tr.enabled=!tr.enabled;

    document.getElementById(t==='A'?'micI':'camI')
        .className=`fa fa-${t==='A'?(tr.enabled?'microphone':'microphone-slash'):(tr.enabled?'video':'video-slash')}`;
}

initCamera(camMode);

</script>
</body>
</html>
